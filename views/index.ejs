<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Nhập Đơn Hàng Đại Lý</title>
  <link rel="stylesheet" href="/style.css" />
</head>
<body>
  <div class="container">
    <h1>Nhập Đơn Hàng Đại Lý</h1>

    <% if (locals.success) { %>
      <div class="alert success">Ghi thành công!</div>
    <% } %>
    <% if (locals.error) { %>
      <div class="alert error"><%= error %></div>
    <% } %>

    <form method="POST" action="/submit">
      <div class="form-group">
        <label>Người nhập:</label>
        <input type="text" name="user_name" value="Kế toán" />
      </div>

      <table id="order-table">
        <thead>
          <tr>
            <th>Đại lý</th>
            <th>Sản phẩm</th>
            <th>Giá</th>
            <th>Số lượng</th>
            <th>Tổng</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <tr class="entry-row">
            <td>
              <select name="agent_0" required onchange="updatePrice(0)">
                <option value="">-- Chọn đại lý --</option>
                <% agents.forEach(a => { %>
                  <option><%= a %></option>
                <% }) %>
              </select>
            </td>
            <td>
              <select name="product_0" required onchange="updatePrice(0)">
                <option value="">-- Chọn sản phẩm --</option>
                <% products.forEach(p => { %>
                  <option data-price="<%= p.price %>"><%= p.name %></option>
                <% }) %>
              </select>
            </td>
            <td><input type="number" name="price_0" class="price" readonly /></td>
            <td><input type="number" name="qty_0" class="qty" value="1" min="1" onchange="calcTotal(0)" /></td>
            <td><input type="number" name="total_0" class="total" readonly /></td>
            <td><button type="button" onclick="removeRow(this)">Xóa</button></td>
          </tr>
        </tbody>
      </table>

      <button type="button" onclick="addRow()">Thêm dòng (+)</button>
      <button type="submit">Ghi dữ liệu</button>
      <a href="/config" class="btn-config" style="float: right;">Cấu hình</a>
    </form>
  </div>

  <script>
    let rowCount = 1;

    function addRow() {
      const tbody = document.querySelector('#order-table tbody');
      const tr = document.createElement('tr');
      tr.className = 'entry-row';
      tr.innerHTML = `
        <td><select name="agent_${rowCount}" required onchange="updatePrice(${rowCount})">
          <option value="">-- Chọn đại lý --</option>
          ${document.querySelector('[name="agent_0"]').innerHTML}
        </select></td>
        <td><select name="product_${rowCount}" required onchange="updatePrice(${rowCount})">
          <option value="">-- Chọn sản phẩm --</option>
          ${document.querySelector('[name="product_0"]').innerHTML}
        </select></td>
        <td><input type="number" name="price_${rowCount}" class="price" readonly /></td>
        <td><input type="number" name="qty_${rowCount}" class="qty" value="1" min="1" onchange="calcTotal(${rowCount})" /></td>
        <td><input type="number" name="total_${rowCount}" class="total" readonly /></td>
        <td><button type="button" onclick="removeRow(this)">Xóa</button></td>
      `;
      tbody.appendChild(tr);
      rowCount++;
    }

    function removeRow(btn) {
      if (document.querySelectorAll('.entry-row').length > 1) {
        btn.closest('tr').remove();
      }
    }

    function updatePrice(idx) {
      const productSelect = document.querySelector(`[name="product_${idx}"]`);
      const priceInput = document.querySelector(`[name="price_${idx}"]`);
      const selected = productSelect.options[productSelect.selectedIndex];
      const price = selected.getAttribute('data-price') || 0;
      priceInput.value = price;
      calcTotal(idx);
    }

    function calcTotal(idx) {
      const price = parseFloat(document.querySelector(`[name="price_${idx}"]`).value) || 0;
      const qty = parseInt(document.querySelector(`[name="qty_${idx}"]`).value) || 0;
      document.querySelector(`[name="total_${idx}"]`).value = price * qty;
    }

    // Khởi tạo dòng đầu
    updatePrice(0);
  </script>
</body>
</html>