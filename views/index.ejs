<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Nh·∫≠p ƒê∆°n H√†ng ƒê·∫°i L√Ω</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/style.css" />
  <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
</head>
<body>
  <a href="/logout" class="btn-logout-fixed">
    ‚éã ƒêƒÉng xu·∫•t
  </a>

  <div class="container">
    <div class="page-header">
      <h1>Nh·∫≠p ƒê∆°n H√†ng ƒê·∫°i L√Ω</h1>
      
      <% if (user && user.role === 'admin') { %>
        <a href="/admin" class="btn-config" style="background: #6c757d; color: white; padding: 8px 16px; text-decoration: none; border-radius: 6px; font-weight: 500;">
          ‚öô Qu·∫£n l√Ω h·ªá th·ªëng
        </a>
      <% } %>
    </div>

    <% if (locals.success) { %>
      <div class="alert success">‚úì Ghi th√†nh c√¥ng!</div>
    <% } %>
    <% if (locals.error) { %>
      <div class="alert error">‚ö† <%= error %></div>
    <% } %>

    <form method="POST" action="/submit" style="display: flex; flex-direction: column; flex: 1; overflow: hidden;">
    <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center;">
      <label style="font-weight: bold; font-size: 18px;">ƒê·∫°i l√Ω <span style="color:red;">*</span></label><br>
      
      <div style="max-width: 500px; margin: 8px auto 0;">
        <select id="selected-agent" required placeholder="T√¨m v√† ch·ªçn ƒë·∫°i l√Ω..." autocomplete="off">
          <option value="">Ch·ªçn ƒë·∫°i l√Ω...</option>
          <% agents.forEach(a => { %>
            <option value="<%= a.name %>" data-discount="<%= a.discount %>"><%= a.name %></option>
          <% }) %>
        </select>
      </div>
    </div>

    <div class="table-responsive" style="flex: 1; overflow: auto;">
      <table id="order-table">
        <thead>
          <tr>
            <th style="width: 35%;">S·∫£n ph·∫©m</th>
            <th style="width: 10%;">CK (%)</th>
            <th style="width: 15%;">Gi√°</th>
            <th style="width: 10%;">SL</th>
            <th>T·ªïng</th>
            <th>Ti·ªÅn CK</th>
            <th>Th√†nh ti·ªÅn</th>
            <th>X√≥a</th>
          </tr>
        </thead>
        <tbody>
          <!-- D√≤ng ƒë·∫ßu ti√™n -->
          <tr class="entry-row" data-index="0">
            <td data-label="S·∫£n ph·∫©m">
              <select class="product-select" name="product_0" required placeholder="T√¨m s·∫£n ph·∫©m...">
                <option value="">Ch·ªçn s·∫£n ph·∫©m...</option>
                <% products.forEach(p => { %>
                  <option value="<%= p.name %>" data-price="<%= p.price %>"><%= p.name %></option>
                <% }) %>
              </select>
            </td>
            <td data-label="CK (%)">
              <input type="number" name="discount_0" class="discount" readonly value="0" step="0.01" style="background: #f8f9fa; font-weight: bold; text-align: center;" />
            </td>
            <td data-label="Gi√°">
              <input type="number" name="price_0" class="price" readonly tabindex="-1" style="display: none;" />
              <span class="price-display display">0</span>
            </td>
            <td data-label="S·ªë l∆∞·ª£ng"><input type="number" name="qty_0" class="qty" value="1" min="1" oninput="calcTotal(this)" /></td>
            <td data-label="T·ªïng">
              <span class="total display">0</span>
            </td>
            <td data-label="Ti·ªÅn CK">
              <span class="discount-amount display">0</span>
            </td>
            <td data-label="Th√†nh ti·ªÅn">
              <span class="final-amount display" style="font-weight: bold; color: #d63384;">0</span>
            </td>
            <td style="text-align: center;">
              <button type="button" class="btn-remove" onclick="removeRow(this)">‚úï</button>
            </td>
          </tr>
        </tbody>
        <!-- D√íNG T·ªîNG K·∫æT -->
        <tfoot>
          <tr style="background: #e8f5e9; font-weight: bold; font-size: 18px; border-top: 3px solid #4caf50;">
            <td colspan="6" style="text-align: right; padding: 15px; color: #2e7d32;">
              T·ªîNG TH√ÄNH TI·ªÄN:
            </td>
            <td style="text-align: center; padding: 15px; color: #d63384; font-size: 22px; font-weight: bold;">
              <span id="grand-final-amount">0</span> ‚Ç´
            </td>
            <td></td>
          </tr>
        </tfoot>
      </table>
    </div>

    <!-- N√∫t th√™m d√≤ng v√† submit -->
    <div class="action-bar" style="margin-top: 10px; display: flex; justify-content: space-between; align-items: center;">
      <button type="button" onclick="addRow()" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 6px; font-weight: bold;">
        + Th√™m s·∫£n ph·∫©m
      </button>
      <button type="submit" id="submit-btn" style="padding: 12px 30px; font-size: 16px;">üì§ Ghi ƒë∆°n h√†ng</button>
    </div>

    <!-- Hidden fields -->
    <input type="hidden" name="selected_agent" id="form-agent" />
    <input type="hidden" name="selected_discount_percent" id="form-discount" />
  </form>

  <datalist id="agents_list">
    <% agents.forEach(a => { %>
      <option value="<%= a.name %>" data-discount="<%= a.discount %>">
    <% }) %>
  </datalist>

  <datalist id="products_list">
    <% products.forEach(p => { %>
      <option value="<%= p.name %>" data-price="<%= p.price %>">
    <% }) %>
  </datalist>
  </div>

  <!-- Popup th√†nh c√¥ng + In ƒë∆°n h√†ng -->
  <div class="success-popup" id="successPopup">
    <div class="popup-content">
      <div class="popup-icon">‚úì</div>
      <div class="popup-title">ƒê·∫∑t h√†ng th√†nh c√¥ng!</div>
      <p>C·∫£m ∆°n b·∫°n ƒë√£ nh·∫≠p ƒë∆°n h√†ng.</p>
      <div class="popup-order-code" id="popupOrderCode">128122025</div>
      <p>Vui l√≤ng l∆∞u l·∫°i m√£ n√†y ƒë·ªÉ tra c·ª©u sau.</p>

      <!-- N√∫t In ƒë∆°n h√†ng -->
      <button class="popup-btn" style="background: #28a745; margin-top: 15px;" onclick="printOrder()">
        üñ®Ô∏è In ƒë∆°n h√†ng
      </button>

      <button class="popup-btn" onclick="closePopup()">ƒê√≥ng</button>
    </div>
  </div>

  <!-- Khu v·ª±c ·∫©n ƒë·ªÉ t·∫°o b·∫£n in ƒë·∫πp -->
  <div id="print-section" style="display: none;">
    <h1>PHI·∫æU ƒê∆†N H√ÄNG ƒê·∫†I L√ù</h1>

    <table>
      <tbody>
        <tr class="header-info">
          <td width="20%"><strong>M√£ ƒë∆°n h√†ng</strong></td>
          <td width="80%" class="large bold" style="color: #d63384;" id="print-order-code">128122025</td>
        </tr>
        <tr class="header-info">
          <td><strong>T√™n ƒë·∫°i l√Ω</strong></td>
          <td id="print-agent">ƒê·∫°i l√Ω ABC</td>
        </tr>
        <tr class="header-info">
          <td><strong>Chi·∫øt kh·∫•u √°p d·ª•ng</strong></td>
          <td id="print-discount">0</td>%
        </tr>
        <tr class="header-info">
          <td><strong>Ng√†y gi·ªù nh·∫≠p</strong></td>
          <td id="print-datetime">28/12/2025 - 14:30</td>
        </tr>
      </tbody>
    </table>

    <table>
      <thead>
        <tr>
          <th width="5%">STT</th>
          <th width="40%">S·∫£n ph·∫©m</th>
          <th width="15%">Gi√°</th>
          <th width="10%">SL</th>
          <th width="15%">T·ªïng</th>
          <th width="15%">Th√†nh ti·ªÅn</th>
        </tr>
      </thead>
      <tbody id="print-table-body">
        <!-- JS s·∫Ω ƒëi·ªÅn d·ªØ li·ªáu v√†o ƒë√¢y -->
      </tbody>
      <tfoot>
        <tr class="highlight">
          <td colspan="5" class="text-right bold large">T·ªîNG TH√ÄNH TI·ªÄN:</td>
          <td class="text-right large" id="print-grand-final">0 ‚Ç´</td>
        </tr>
      </tfoot>
    </table>

    <table class="no-border">
      <tr class="no-border">
        <td class="no-border text-center" style="padding-top: 40px; color: #666;">
          <em>C·∫£m ∆°n qu√Ω kh√°ch h√†ng ƒë√£ tin t∆∞·ªüng v√† h·ª£p t√°c!</em>
        </td>
      </tr>
    </table>
  </div>

  <div id="session-timer" style="position: fixed; top: 20px; right: 20px; background: #ff4444; color: white; padding: 10px 16px; border-radius: 8px; font-weight: bold; font-size: 14px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 9998; display: none;">
    Phi√™n h·∫øt h·∫°n sau: <span id="timer-display">00:00</span>
  </div>

  <!-- Popup h·∫øt h·∫°n -->
  <div id="session-expired-popup" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 9999; align-items: center; justify-content: center;">
    <div style="background: white; padding: 30px; border-radius: 12px; max-width: 400px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
      <h3 style="color: #d32f2f; margin-top: 0;">‚è∞ Phi√™n nh·∫≠p ƒë∆°n ƒë√£ h·∫øt h·∫°n!</h3>
      <p>ƒê·ªÉ ƒë·∫£m b·∫£o gi√° s·∫£n ph·∫©m ch√≠nh x√°c, h·ªá th·ªëng y√™u c·∫ßu c·∫≠p nh·∫≠t l·∫°i b·∫£ng gi√°.</p>
      <p><strong>D·ªØ li·ªáu b·∫°n ƒë√£ nh·∫≠p s·∫Ω ƒë∆∞·ª£c gi·ªØ nguy√™n.</strong></p>
      <button onclick="refreshPrices()" style="padding: 12px 24px; background: #1976d2; color: white; border: none; border-radius: 6px; font-size: 16px; cursor: pointer;">
        OK - C·∫≠p nh·∫≠t gi√° m·ªõi
      </button>
    </div>
  </div>

  <script>
    // C·∫•u h√¨nh th·ªùi gian phi√™n
    const SESSION_MINUTES = <%= sessionMinutes %>;
    const SERVER_END_TIME = new Date('<%= sessionEndTime %>').getTime();

    let sessionEndTime = SERVER_END_TIME;
    let timerInterval = null;

    let rowCount = 1;
    let isSubmitting = false;
    let selectedAgent = '';
    let selectedDiscount = 0;

    new TomSelect("#selected-agent", {
        create: true, // Cho ph√©p nh·∫≠p ƒë·∫°i l√Ω m·ªõi kh√¥ng c√≥ trong list
        dropdownParent: 'body',
        sortField: { field: "text", direction: "asc" },
        onChange: function(value) {
            selectedAgent = value;

            const options = this.options; 
            const item = options[value];
            
            // Logic t√¨m discount:
            let foundDiscount = 0;
            const originalOption = document.querySelector(`#selected-agent option[value="${value}"]`);
            if (originalOption && originalOption.dataset.discount) {
                foundDiscount = parseFloat(originalOption.dataset.discount);
            }
            
            selectedDiscount = foundDiscount;

            // C·∫≠p nh·∫≠t giao di·ªán
            document.querySelectorAll('.discount').forEach(el => el.value = selectedDiscount);
            
            // T√≠nh l·∫°i ti·ªÅn
            document.querySelectorAll('.entry-row').forEach(row => {
                const qtyInput = row.querySelector('.qty');
                if (qtyInput) calcTotal(qtyInput);
            });
            updateGrandTotal();
        }
    });

    const productOptionsHTML = `
        <option value="">Ch·ªçn s·∫£n ph·∫©m...</option>
        <% products.forEach(p => { %>
            <option value="<%= p.name %>" data-price="<%= p.price %>"><%= p.name %></option>
        <% }) %>
    `;

    function initProductSelect(selectElement) {
        new TomSelect(selectElement, {
            create: false,
            sortField: { field: "text", direction: "asc" },
            dropdownParent: 'body',
            onChange: function(value) {
                const row = selectElement.closest('tr');
                const priceInput = row.querySelector('.price');
                const priceDisplay = row.querySelector('.price-display');

                const key = value.toLowerCase().replace(/"/g, '\\"');
                
                if (productPricesAtLoad[key] !== undefined) {
                    const price = productPricesAtLoad[key];
                    priceInput.value = price;
                    priceDisplay.textContent = price.toLocaleString('vi-VN');
                } else {
                    priceInput.value = '';
                    priceDisplay.textContent = '0';
                }
                
                // T√≠nh l·∫°i ti·ªÅn d√≤ng n√†y
                calcTotal(row.querySelector('.qty'));
            }
        });
    }
    
    const productPricesAtLoad = {};
    <% products.forEach(p => { %>
       productPricesAtLoad["<%= p.name.toLowerCase().replace(/"/g, '\\"') %>"] = <%= p.price %>;
    <% }) %>

    // Kh·ªüi t·∫°o cho d√≤ng ƒë·∫ßu ti√™n ngay khi load trang
    document.addEventListener('DOMContentLoaded', () => {
        const firstSelect = document.querySelector('tr[data-index="0"] .product-select');
        if(firstSelect) initProductSelect(firstSelect);

        startTimer();
    });

        function startTimer() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }

      const timerDisplay = document.getElementById('timer-display');
      const timerBox = document.getElementById('session-timer');

      function update() {
        const now = Date.now();
        const diff = sessionEndTime - now;

        if (diff <= 0) {
          timerBox.style.display = 'none';
          document.getElementById('session-expired-popup').style.display = 'flex';
          return;
        }

        const minutes = Math.floor(diff / 60000);
        const seconds = Math.floor((diff % 60000) / 1000);
        timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

        if (diff <= 5 * 60 * 1000) {
          timerBox.style.background = '#d32f2f';
          timerBox.style.animation = 'pulse 1s infinite';
        } else {
          timerBox.style.background = '#ff4444';
          timerBox.style.animation = 'none';
        }

        timerBox.style.display = 'block';
      }

      // CH·ªà setInterval, KH√îNG g·ªçi update() ngay
      timerInterval = setInterval(update, 1000);

      // Thay v√†o ƒë√≥, g·ªçi update SAU 300ms ƒë·ªÉ tr√°nh race condition
      setTimeout(update, 300);
    }
    
    async function refreshPrices() {
      try {
        document.getElementById('session-expired-popup').style.display = 'none';

        // 1. C·∫≠p nh·∫≠t s·∫£n ph·∫©m m·ªõi
        const response = await fetch('/api/products');
        if (!response.ok) throw new Error('Kh√¥ng th·ªÉ k·∫øt n·ªëi API s·∫£n ph·∫©m');
        const newProducts = await response.json();

        const newPriceMap = {};
        newProducts.forEach(p => {
          newPriceMap[p.name.trim()] = p.price;
        });

        document.querySelectorAll('.product-select').forEach(select => {
          const ts = select.tomselect;
          if (!ts) return;

          const currentValue = ts.getValue();

          ts.clearOptions();
          newProducts.forEach(p => {
            const name = p.name.trim();
            ts.addOption({ value: name, text: name });
          });

          if (currentValue && newPriceMap[currentValue.trim()]) {
            ts.setValue(currentValue.trim(), true);
          }

          ts.refreshOptions(false);
        });

        document.querySelectorAll('.entry-row').forEach(row => {
          const productSelect = row.querySelector('.product-select');
          const selectedProduct = productSelect?.tomselect?.getValue()?.trim();

          if (selectedProduct && newPriceMap[selectedProduct] !== undefined) {
            const newPrice = newPriceMap[selectedProduct];
            row.querySelector('.price').value = newPrice;
            row.querySelector('.price-display').textContent = newPrice.toLocaleString('vi-VN');
            calcTotal(row.querySelector('.qty'));
          }
        });

        // 2. Gia h·∫°n phi√™n
        const resetRes = await fetch('/api/reset-session', { method: 'POST' });
        if (!resetRes.ok) throw new Error('Kh√¥ng th·ªÉ gia h·∫°n phi√™n');

        const resetData = await resetRes.json();
        sessionEndTime = new Date(resetData.sessionEndTime).getTime();

        // 3. T·∫°o l·∫°i timer m·ªõi (clear c≈©, d√πng sessionEndTime m·ªõi)
        startTimer();
      } catch (err) {
        console.error('L·ªói refreshPrices:', err);
        alert('‚ùå L·ªói: ' + err.message + '\nVui l√≤ng t·∫£i l·∫°i trang (F5).');
      }
    }

    function calcTotal(input) {
      if (!input) return;
      const row = input.closest('tr');
      const qty = parseInt(row.querySelector('.qty').value) || 0;
      const price = parseFloat(row.querySelector('.price').value) || 0;
      const total = price * qty;
      const discountAmount = total * (selectedDiscount / 100);
      const final = total - discountAmount;

      const formatNumber = (num) => num.toLocaleString('vi-VN');

      row.querySelector('.total.display').textContent = formatNumber(total);
      row.querySelector('.discount-amount.display').textContent = formatNumber(discountAmount);
      row.querySelector('.final-amount.display').textContent = formatNumber(final);

      updateGrandTotal();
    }

    // C·∫≠p nh·∫≠t t·ªïng th√†nh ti·ªÅn to√†n b·ªô ƒë∆°n
    function updateGrandTotal() {
      let grandFinal = 0;

      document.querySelectorAll('.entry-row').forEach(row => {
        const finalText = row.querySelector('.final-amount.display').textContent;
        const finalAmt = parseFloat(finalText.replace(/\./g, '')) || 0;
        grandFinal += finalAmt;
      });

      document.getElementById('grand-final-amount').textContent = 
        grandFinal.toLocaleString('vi-VN');
    }

    function addRow() {
      const tbody = document.querySelector('#order-table tbody');
      const index = rowCount++;
      const tr = document.createElement('tr');
      tr.className = 'entry-row';
      tr.dataset.index = index;
      
      // Ch√∫ √Ω: input name="product_..." gi·ªù l√† select
      tr.innerHTML = `
        <td data-label="S·∫£n ph·∫©m">
            <select class="product-select" name="product_${index}" required placeholder="T√¨m s·∫£n ph·∫©m...">
                ${productOptionsHTML}
            </select>
        </td>
        <td data-label="CK (%)"><input type="number" name="discount_${index}" class="discount" readonly value="${selectedDiscount || 0}" step="0.01" style="background: #f8f9fa; font-weight: bold; text-align: center;" /></td>
        <td data-label="Gi√°">
          <input type="number" name="price_${index}" class="price" readonly tabindex="-1" style="display: none;" />
          <span class="price-display display">0</span>
        </td>
        <td data-label="S·ªë l∆∞·ª£ng"><input type="number" name="qty_${index}" class="qty" value="1" min="1" oninput="calcTotal(this)" /></td>
        <td data-label="T·ªïng"><span class="total display">0</span></td>
        <td data-label="Ti·ªÅn CK"><span class="discount-amount display">0</span></td>
        <td data-label="Th√†nh ti·ªÅn"><span class="final-amount display" style="font-weight: bold; color: #d63384;">0</span></td>
        <td style="text-align: center;"><button type="button" class="btn-remove" onclick="removeRow(this)">‚úï</button></td>
      `;
      tbody.appendChild(tr);

      // QUAN TR·ªåNG: Kh·ªüi t·∫°o Tom Select cho select v·ª´a sinh ra
      const newSelect = tr.querySelector('.product-select');
      initProductSelect(newSelect);

      tr.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    function removeRow(btn) {
      if (document.querySelectorAll('.entry-row').length > 1) {
        btn.closest('tr').remove();
        updateGrandTotal();
      }
    }

    // Submit handler
    document.querySelector('form').addEventListener('submit', function(e) {
      if (isSubmitting) { e.preventDefault(); return; }

      if (!selectedAgent) {
        alert('Vui l√≤ng nh·∫≠p t√™n ƒë·∫°i l√Ω!');
        e.preventDefault();
        return;
      }

      let hasValidRow = false;
      const products = [];

      document.querySelectorAll('.entry-row').forEach(row => {
        const productSelect = row.querySelector('.product-select'); 
        const product = productSelect.value.trim();
        
        const qty = parseInt(row.querySelector('.qty').value) || 0;
        const price = parseFloat(row.querySelector('.price').value) || 0;

        if (product && qty > 0 && price > 0) {
          hasValidRow = true;

          const priceText = row.querySelector('.price-display')?.textContent || price.toLocaleString('vi-VN');
          const totalText = row.querySelector('.total.display')?.textContent || '0';
          const finalText = row.querySelector('.final-amount.display')?.textContent || '0';

          products.push({
            product,
            price: priceText,
            qty: qty.toString(),
            total: totalText,
            final: finalText
          });
        }
      });

      if (!hasValidRow) {
        alert('Vui l√≤ng nh·∫≠p √≠t nh·∫•t m·ªôt s·∫£n ph·∫©m h·ª£p l·ªá!');
        e.preventDefault();
        return;
      }

      // L∆ØU D·ªÆ LI·ªÜU V√ÄO sessionStorage TR∆Ø·ªöC KHI SUBMIT
      const tempOrderData = {
        agent: selectedAgent,
        discount: selectedDiscount,
        products: products,
        grandTotal: document.getElementById('grand-final-amount').textContent,
        datetime: new Date().toLocaleString('vi-VN')
      };
      sessionStorage.setItem('tempOrderData', JSON.stringify(tempOrderData));

      // Cho ph√©p submit
      document.getElementById('form-agent').value = selectedAgent;
      document.getElementById('form-discount').value = selectedDiscount;

      isSubmitting = true;
      const submitBtn = document.getElementById('submit-btn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'ƒêang l∆∞u...';
    });

    document.querySelectorAll('.entry-row').forEach(calcTotal);

    // popup
    const urlParams = new URLSearchParams(window.location.search);
    const orderCode = urlParams.get('orderCode');

    if (orderCode) {
      document.getElementById('popupOrderCode').textContent = orderCode;
      document.getElementById('successPopup').classList.add('show');

      // L·∫•y d·ªØ li·ªáu t·∫°m ƒë√£ l∆∞u tr∆∞·ªõc submit
      const tempData = sessionStorage.getItem('tempOrderData');
      if (tempData) {
        const data = JSON.parse(tempData);
        const fullOrderData = {
          orderCode: orderCode,
          agent: data.agent || '',
          discount: data.discount || 0,
          datetime: data.datetime || new Date().toLocaleString('vi-VN'),
          products: data.products || [],
          grandTotal: data.grandTotal || '0'
        };

        // L∆∞u ch√≠nh th·ª©c ƒë·ªÉ in
        sessionStorage.setItem('lastOrderData', JSON.stringify(fullOrderData));

        // X√≥a t·∫°m
        sessionStorage.removeItem('tempOrderData');
      }
    }

    // H√†m in ƒë∆°n h√†ng - l·∫•y d·ªØ li·ªáu t·ª´ sessionStorage
    function printOrder() {
      const savedData = sessionStorage.getItem('lastOrderData');
      if (!savedData) {
        alert('Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ƒë∆°n h√†ng ƒë·ªÉ in. Vui l√≤ng th·ª≠ l·∫°i.');
        return;
      }

      const data = JSON.parse(savedData);

      // ƒêi·ªÅn th√¥ng tin header
      document.getElementById('print-order-code').textContent = data.orderCode;
      document.getElementById('print-agent').textContent = data.agent || 'Ch∆∞a x√°c ƒë·ªãnh';
      document.getElementById('print-discount').textContent = data.discount;
      document.getElementById('print-datetime').textContent = data.datetime;

      // ƒêi·ªÅn b·∫£ng s·∫£n ph·∫©m
      const tbody = document.getElementById('print-table-body');
      tbody.innerHTML = '';

      data.products.forEach((item, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="text-center">${index + 1}</td>
          <td>${item.product}</td>
          <td class="text-right">${item.price}</td>
          <td class="text-right">${item.qty}</td>
          <td class="text-right">${item.total}</td>
          <td class="text-right bold">${item.final}</td>
        `;
        tbody.appendChild(tr);
      });

      // T·ªïng th√†nh ti·ªÅn
      document.getElementById('print-grand-final').textContent = data.grandTotal + ' ‚Ç´';

      // ·∫®n giao di·ªán ch√≠nh v√† popup
      document.getElementById('successPopup').style.display = 'none';
      document.querySelector('.container').style.display = 'none';
      document.querySelector('.btn-logout-fixed').style.display = 'none';

      // Hi·ªÉn th·ªã ph·∫ßn in
      document.getElementById('print-section').style.display = 'block';

      // In
      window.print();

      // Sau khi in xong, hi·ªán l·∫°i giao di·ªán
      document.getElementById('successPopup').style.display = 'flex';
      document.querySelector('.container').style.display = 'block';
      document.querySelector('.btn-logout-fixed').style.display = 'block';
      document.getElementById('print-section').style.display = 'none';
    }

    function closePopup() {
      document.getElementById('successPopup').classList.remove('show');
      history.replaceState(null, '', '/');
    }

    // ƒê√≥ng popup khi click n·ªÅn ƒëen
    document.getElementById('successPopup').addEventListener('click', function(e) {
      if (e.target === this) {
        closePopup();
      }
    });
  </script>
</body>
</html>